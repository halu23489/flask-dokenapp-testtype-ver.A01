{% extends "layout.html" %}

{% block extra_head %}
    <style>
        .comparison-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn-action {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            font-size: 14px;
            transition: opacity 0.2s;
        }

        .btn-add-product {
            background-color: #28a745;
        }

        .btn-add-item {
            background-color: #007bff;
        }

        .btn-export {
            background-color: #6c757d;
        }

        .btn-action:hover {
            opacity: 0.85;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            margin: 2px;
        }

        .btn-delete {
            background-color: #dc3545;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            margin-bottom: 20px;
        }

        .comparison-table th,
        .comparison-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            vertical-align: middle;
        }

        .comparison-table th {
            background-color: #e7f3ff;
            font-weight: bold;
            min-height: 40px;
        }

        .row-header {
            background-color: #f0f9ff;
            font-weight: bold;
            text-align: left;
            min-width: 100px;
        }

        .header-cell {
            position: relative;
        }

        .header-input {
            width: 100%;
            padding: 8px 4px;
            border: 1px solid #ccc;
            font-weight: bold;
            text-align: center;
            box-sizing: border-box;
            border-radius: 3px;
        }

        .header-input:focus {
            outline: none;
            border-color: #007bff;
            background-color: #fffacd;
        }

        .cell-input {
            width: 100%;
            min-height: 40px;
            padding: 8px;
            border: 1px solid #f0f0f0;
            box-sizing: border-box;
            font-size: 13px;
            border-radius: 3px;
        }

        .cell-input:focus {
            outline: none;
            border-color: #007bff;
            background-color: #fffacd;
        }

        textarea.cell-input {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .image-cell {
            text-align: center;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        .image-preview {
            max-width: 100%;
            max-height: 120px;
            object-fit: contain;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .image-input {
            font-size: 12px;
        }

        .row-controls {
            display: flex;
            gap: 4px;
            justify-content: center;
        }

        .column-controls {
            display: flex;
            gap: 4px;
            justify-content: center;
            margin-top: 4px;
        }

        .item-type-selector {
            font-size: 12px;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 3px;
            background-color: white;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 16px;
        }

        .export-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
        }
    </style>
{% endblock %}

{% block content %}
<div class="comparison-container">
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">📊 比較見積もりテーブル</h5>
        </div>
        <div class="card-body">
            <p class="text-muted">複数の製品を比較するための表を自由に編集できます。</p>

            <div class="button-group">
                <form method="POST" action="{{ url_for('comparison_tool_page') }}" style="display: inline;">
                    <input type="hidden" name="action" value="add_column">
                    <button type="submit" class="btn-action btn-add-product">+ 比較対象を追加</button>
                </form>

                <form method="POST" action="{{ url_for('comparison_tool_page') }}" style="display: inline;">
                    <input type="hidden" name="action" value="add_row">
                    <select name="row_type" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-right: 10px;">
                        <option value="text">テキスト項目</option>
                        <option value="number">数値項目</option>
                        <option value="textarea">説明文</option>
                    </select>
                    <button type="submit" class="btn-action btn-add-item">+ 比較項目を追加</button>
                </form>

                <form method="POST" action="{{ url_for('comparison_tool_page') }}" style="display: inline;">
                    <input type="hidden" name="action" value="export_excel">
                    <button type="submit" class="btn-action btn-export">📥 CSVダウンロード</button>
                </form>
            </div>

            {% if columns and columns|length > 0 and rows and rows|length > 0 %}
                <form method="POST" action="{{ url_for('comparison_tool_page') }}" id="comparisonForm">
                    <input type="hidden" name="action" value="save_data">
                    
                    <div style="overflow-x: auto;">
                        <table class="comparison-table">
                            <thead>
                                <tr>
                                    <th style="width: 120px; background-color: white;"></th>
                                    {% for col in columns %}
                                        <th class="header-cell">
                                            <input type="text" 
                                                   class="header-input" 
                                                   name="col_name_{{ col.id }}" 
                                                   value="{{ col.name }}" 
                                                   placeholder="製品名">
                                            <div class="column-controls">
                                                <form method="POST" action="{{ url_for('comparison_tool_page') }}" style="display: inline;">
                                                    <input type="hidden" name="action" value="delete_column">
                                                    <input type="hidden" name="col_id" value="{{ col.id }}">
                                                    <button type="submit" class="btn-action btn-small btn-delete" 
                                                            onclick="return confirm('この列を削除しますか？')">削除</button>
                                                </form>
                                            </div>
                                        </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in rows %}
                                    <tr>
                                        <td class="row-header">
                                            <input type="text" 
                                                   class="header-input" 
                                                   name="row_name_{{ row.id }}" 
                                                   value="{{ row.label }}" 
                                                   placeholder="項目名"
                                                   style="width: 100%; text-align: left;">
                                            <div class="row-controls" style="margin-top: 4px;">
                                                <form method="POST" action="{{ url_for('comparison_tool_page') }}" style="display: inline;">
                                                    <input type="hidden" name="action" value="delete_row">
                                                    <input type="hidden" name="row_id" value="{{ row.id }}">
                                                    <button type="submit" class="btn-action btn-small btn-delete"
                                                            onclick="return confirm('この行を削除しますか？')">削除</button>
                                                </form>
                                            </div>
                                        </td>
                                        {% for col in columns %}
                                            <td>
                                                {% if row.type == 'image' %}
                                                    <div class="image-cell">
                                                        {% set row_key = row.id|string %}
                                                        {% set col_key = col.id|string %}
                                                        {% set img_data = data.get(row_key, {}).get(col_key) %}
                                                        {% if img_data %}
                                                            <img src="data:image/jpeg;base64,{{ img_data }}" class="image-preview">
                                                        {% endif %}
                                                        <input type="file" 
                                                               name="image_{{ row.id }}_{{ col.id }}" 
                                                               accept="image/*" 
                                                               class="image-input">
                                                    </div>
                                                {% elif row.type == 'textarea' %}
                                                    {% set row_key = row.id|string %}
                                                    {% set col_key = col.id|string %}
                                                    <textarea class="cell-input" 
                                                              name="data_{{ row.id }}_{{ col.id }}"
                                                              placeholder="入力してください">{{ data.get(row_key, {}).get(col_key, '') }}</textarea>
                                                {% else %}
                                                    {% set row_key = row.id|string %}
                                                    {% set col_key = col.id|string %}
                                                    <input type="text" 
                                                           class="cell-input" 
                                                           name="data_{{ row.id }}_{{ col.id }}"
                                                           value="{{ data.get(row_key, {}).get(col_key, '') }}"
                                                           placeholder="入力してください">
                                                {% endif %}
                                            </td>
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div style="margin-top: 20px;">
                        <button type="submit" class="btn-action btn-add-item">💾 データを保存</button>
                    </div>
                </form>
            {% else %}
                <div class="no-data">
                    まず「比較対象を追加」ボタンで製品を追加し、「比較項目を追加」で項目を追加してください。
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
