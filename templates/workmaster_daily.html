{% extends "base.html" %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-10">
    <!-- 基本情報・詳細内容サマリー -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-info text-white"><i class="bi bi-info-circle me-2"></i>プロジェクト情報サマリー</div>
      <div class="card-body">
        <p><strong>現場名:</strong> {{ basic_data.site_name }}</p>
        <p><strong>作業内容:</strong> {{ basic_data.task_name }}</p>
        <p><strong>期間:</strong> {{ basic_data.period }}</p>
        <p><strong>業者名:</strong> {{ basic_data.contractor }}</p>
        <p><strong>使用機械類:</strong> {{ basic_data.machines }}</p>
        <p><strong>歩掛項目:</strong> {{ detail_data.work_unit }}</p>
      </div>
    </div>

    <!-- 日々の作業記録入力フォーム -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-success text-white"><i class="bi bi-pencil-square me-2"></i>日々の作業記録入力</div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('workmaster_daily') }}">
          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <label for="record_date" class="form-label fw-bold">日付</label>
              <input type="date" class="form-control" id="record_date" name="record_date" required>
            </div>
            <div class="col-md-4">
              <label for="weather" class="form-label fw-bold">天候</label>
              <select class="form-select" id="weather" name="weather">
                <option value="晴れ">☀️ 晴れ</option>
                <option value="曇り">☁️ 曇り</option>
                <option value="雨">☔ 雨</option>
                <option value="雪">❄️ 雪</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="work_time" class="form-label fw-bold">作業時間（時間）</label>
              <input type="number" class="form-control" id="work_time" name="work_time" placeholder="例: 8.0" step="0.5" required min="0.5">
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">人工（人数とOP数）</label>
            <div class="row g-2">
              <div class="col-md-6">
                <input type="number" class="form-control" name="person_count" placeholder="作業員人数" required min="1">
              </div>
              <div class="col-md-6">
                <input type="number" class="form-control" name="op_count" placeholder="OP（オペレーター）数" min="0" value="0">
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="machine_count" class="form-label fw-bold">使用した機械の数</label>
            <input type="number" class="form-control" id="machine_count" name="machine_count" placeholder="例: 2" min="0" value="0">
          </div>

          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label for="progress_value" class="form-label fw-bold">本日の進捗（実績値）</label>
              <input type="number" class="form-control" id="progress_value" name="progress_value" placeholder="例: 10.5" step="0.1" required>
            </div>
            <div class="col-md-6">
              <label for="progress_total" class="form-label fw-bold">累積進捗（合計）</label>
              <input type="number" class="form-control" id="progress_total" name="progress_total" placeholder="例: 50.0" step="0.1" required>
            </div>
          </div>

          <div class="mb-3">
            <label for="remarks" class="form-label fw-bold">備考（特記事項）</label>
            <textarea class="form-control" id="remarks" name="remarks" rows="3" placeholder="来客対応で30分作業中断あり。"></textarea>
          </div>

          <button type="submit" class="btn btn-primary mt-3"><i class="bi bi-check2-circle me-2"></i>本日の記録を登録</button>
        </form>
      </div>
    </div>

    <!-- 過去の記録一覧 -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-dark text-white"><i class="bi bi-list-columns-reverse me-2"></i>過去の作業記録一覧</div>
      <div class="card-body">
        {% if export_message %}
          <div class="alert alert-info" role="alert">{{ export_message }}</div>
        {% endif %}

        {% if recent_records %}
          <p class="text-end">
            <a href="{{ url_for('workmaster_export_excel') }}" class="btn btn-outline-success"><i class="bi bi-file-earmark-spreadsheet me-2"></i>Excelデータを出力</a>
          </p>
          <div class="table-responsive">
            <table class="table table-striped table-hover small">
              <thead class="table-light">
                <tr>
                  <th>日付</th>
                  <th>天候</th>
                  <th>人工</th>
                  <th>機械数</th>
                  <th>時間</th>
                  <th>進捗</th>
                  <th>備考</th>
                </tr>
              </thead>
              <tbody>
                {% for record in recent_records %}
                <tr>
                  <td>{{ record.date }}</td>
                  <td>{{ record.weather }}</td>
                  <td>{{ record.person_count }}名 / OP{{ record.op_count }}名</td>
                  <td>{{ record.machine_count }}台</td>
                  <td>{{ record.work_time }}h</td>
                  <td>{{ record.progress_value }}/{{ record.progress_total }} {{ detail_data.work_unit }}<br>
                    <small>({% if record.progress_total|float > 0 %}{{ ((record.progress_value|float / record.progress_total|float) * 100)|round(1) }}%{% else %}0%{% endif %})</small>
                  </td>
                  <td>{{ record.remarks | default('-', true) | truncate(30) }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="alert alert-warning" role="alert">
            まだ作業記録がありません。上記のフォームから入力してください。
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
